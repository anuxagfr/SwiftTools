<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileForge - The All-in-One File Toolkit</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.0/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Cloud Picker SDKs -->
    <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
    <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="jqxafclr8kmxfln"></script>
    <!-- OneDrive SDK removed -->

    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .drag-area-highlight { background-color: #e0f2fe; border-color: #0284c7; }
        .smooth-transition { transition: all 0.3s ease-in-out; }
        .dropdown:hover .dropdown-menu { display: block; }
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: white;
            z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        .plan-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .fade-in-up { animation: fadeInUp 1s ease-out forwards; opacity: 0; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .delay-1 { animation-delay: 0.2s; }
        .delay-2 { animation-delay: 0.4s; }
        
        .form-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, max-height 0.3s ease-in-out;
            max-height: 1000px;
            overflow: hidden;
        }
        .form-hidden {
            opacity: 0;
            transform: scale(0.98);
            max-height: 0;
        }

        .premium-lock { display: none; }
        .tool-link.locked {
            opacity: 0.7;
            background-color: #f8fafc;
        }
        .tool-link.locked:hover {
            background-color: #f1f5f9;
        }
        .tool-link.locked .premium-lock {
            display: block;
        }
        .tool-link:not(.locked) .premium-lock {
            display: none;
        }
        #auth-links.auth-hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <nav class="bg-white/90 backdrop-blur-sm shadow-md border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" /></svg>
                        <a href="#" id="homeLink" class="ml-2 text-xl font-bold text-slate-800">FileForge</a>
                    </div>
                    <div class="hidden md:flex items-center space-x-1 ml-10">
                        <a href="#compressor" id="compressorLinkNav" class="text-slate-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Compressor</a>
                        <a href="#all-tools" id="allToolsLinkNav" class="text-slate-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">All Tools</a>
                        <a href="#pricing" id="pricingLinkNav" class="text-slate-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Pricing</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="credit-container" class="hidden md:flex items-center space-x-2 bg-indigo-100 text-indigo-700 font-semibold px-3 py-1.5 rounded-full">
                         <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5A.75.75 0 0110 2zM10 18a.75.75 0 01.75-.75v-.5a.75.75 0 01-1.5 0v.5A.75.75 0 0110 18zM5.106 14.142a.75.75 0 010-1.06l.353-.353a.75.75 0 111.06 1.06l-.353.353a.75.75 0 01-1.06 0zM14.142 5.106a.75.75 0 011.06 0l.353.353a.75.75 0 01-1.06 1.06l-.353-.353a.75.75 0 010-1.06zM18 10a.75.75 0 01-.75.75h-.5a.75.75 0 010-1.5h.5A.75.75 0 0118 10zM2 10a.75.75 0 01.75-.75h.5a.75.75 0 010 1.5h-.5A.75.75 0 012 10zM14.142 14.142a.75.75 0 011.06 0l.353.353a.75.75 0 11-1.06 1.06l-.353-.353a.75.75 0 010-1.06zM5.106 5.106a.75.75 0 010 1.06l-.353.353a.75.75 0 11-1.06-1.06l.353-.353a.75.75 0 011.06 0z" /><path d="M10 5a5 5 0 100 10 5 5 0 000-10zM10 7a3 3 0 100 6 3 3 0 000-6z" /></svg>
                        <span>Credits: <span id="credit-count">00</span></span>
                    </div>

                    <div id="auth-links" class="hidden md:flex items-center space-x-2">
                        <button id="loginBtn" class="text-slate-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Login</button>
                        <button id="signupBtn" class="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-md text-sm font-medium">Sign Up</button>
                    </div>
                    <div id="profile-container" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden cursor-pointer" title="My Account">
                        <img id="profile-img" src="" alt="Profile Picture" class="hidden h-full w-full object-cover">
                        <svg id="default-avatar" class="h-6 w-6 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                    </div>

                </div>
            </div>
        </div>
    </nav>

    <main class="w-full max-w-7xl mx-auto p-4 md:p-8">
        <section id="home" class="main-section mb-20 text-center">
            <div class="py-20 px-6">
                <h1 class="text-5xl md:text-6xl font-extrabold text-slate-900 tracking-tight fade-in-up">
                    Your Complete Online File Toolkit
                </h1>
                <p class="fade-in-up delay-1 mt-6 max-w-3xl mx-auto text-lg text-slate-600">
                    Effortlessly compress, convert, edit, and manage all your files in one secure place. Fast, private, and entirely in your browser.
                </p>
                <div class="fade-in-up delay-2 mt-10">
                    <a href="#compressor" id="homeGetStartedBtn" class="bg-indigo-600 text-white font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-indigo-700 smooth-transition text-lg">
                        Get Started for Free
                    </a>
                </div>
            </div>
        </section>


           <section id="compressor" class="main-section mb-20">
             <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden max-w-5xl mx-auto">
                 <header class="text-center p-6 border-b border-slate-200">
                     <h1 class="text-3xl font-bold text-slate-900">File Compressor</h1>
                     <p class="text-slate-500 mt-2">Compress single or multiple files at once. Fast, private, and free.</p>
                 </header>
                 <div class="p-6 md:p-8">
                     <div id="uploadSelection">
                          <div class="grid md:grid-cols-2 gap-8 items-center">
                              <div id="uploadArea" class="relative block w-full h-full min-h-[300px] rounded-lg border-2 border-dashed border-slate-300 p-6 text-center hover:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 smooth-transition flex flex-col justify-center items-center">
                                  <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                      <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                  </svg>
                                  <span class="mt-4 block text-sm font-semibold text-slate-700">Drag & Drop File(s) Here</span>
                                  <span class="mt-1 block text-xs text-slate-500">Supports Images, PDF, TXT, and more</span>
                              </div>
                              <div class="space-y-3">
                                  <button id="deviceBtn" class="w-full flex items-center justify-center text-center p-4 bg-indigo-600 text-white rounded-lg shadow-sm hover:bg-indigo-700 smooth-transition font-semibold">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                      Choose File(s) from Device
                                  </button>
                                  <div class="grid grid-cols-2 gap-3">
                                      <button id="urlBtn" class="w-full flex items-center p-3 bg-slate-100 hover:bg-slate-200 rounded-lg smooth-transition text-sm font-medium">
                                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0m-2.828-2.828a2 2 0 012.828 0l3 3a2 2 0 010 2.828l-3 3a2 2 0 01-2.828-2.828l3-3a2 2 0 010-2.828zM10 5a1 1 0 100-2 1 1 0 000 2zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                          Add from URL
                                      </button>
                                      <button id="clipboardBtn" class="w-full flex items-center p-3 bg-slate-100 hover:bg-slate-200 rounded-lg smooth-transition text-sm font-medium">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                                           Paste Image
                                      </button>
                                  </div>
                                   <div class="relative">
                                       <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-300"></div></div>
                                       <div class="relative flex justify-center"><span class="bg-white px-2 text-xs text-slate-500">Cloud Storage</span></div>
                                   </div>
                                  <div class="grid grid-cols-2 gap-3"> <!-- Changed grid-cols-3 to grid-cols-2 -->
                                       <button id="driveBtn" class="cloud-btn w-full flex items-center justify-center p-3 bg-slate-100 hover:bg-slate-200 rounded-lg smooth-transition text-sm font-medium">
                                           <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M38.5,12.5l-13.9,24l-14,-24h27.9Z" fill="#ffc107"/><path d="M24.6,36.5l14.2,-24.1l-28.2,0l14,24.1Z" fill="#ffeb3b"/><path d="M10.5,12.5l14,24l14,-24l-28,0Z" fill="#4caf50"/></svg>
                                           Drive
                                       </button>
                                       <button id="dropboxBtn" class="cloud-btn w-full flex items-center justify-center p-3 bg-slate-100 hover:bg-slate-200 rounded-lg smooth-transition text-sm font-medium">
                                           <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="#0061FE" xmlns="http://www.w3.org/2000/svg"><path d="M6.331 4.282l5.666-3.856 5.668 3.856-5.668 3.857L6.33 4.282zm11.334 5.23L12 13.368l-5.665-3.856L.668 13.368l5.663 3.856 5.668-3.856 5.667 3.856 5.667-3.856-5.667-3.856zM12 15.29l5.667 3.856v-5.23L12 10.06l-5.665 3.856v5.23l5.665-3.856z"/></svg>
                                           Dropbox
                                       </button>
                                       <!-- OneDrive Button Removed -->
                                  </div>
                              </div>
                          </div>
                     </div>
                     <div id="processingArea" class="hidden">
                         <!-- This section is populated by JS -->
                     </div>
                 </div>
             </div>
        </section>
        <section id="all-tools" class="main-section pt-16 mb-20">
            <div class="max-w-7xl mx-auto">
                <header class="text-center mb-16">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight">All Our Tools</h1>
                    <p class="mt-4 max-w-3xl mx-auto text-lg text-slate-600">A complete suite of tools to convert, compress, edit, and sign your documents, all in one place.</p>
                </header>
                <div id="all-tools-container" class="space-y-12">
                    </div>
            </div>
        </section>

        <section id="pricing" class="main-section pt-16 mb-20">
            <div class="max-w-5xl mx-auto">
                 <header class="text-center mb-12">
                    <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">Flexible Plans for Everyone</h1>
                    <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-600">Choose a credit pack that suits your needs. Get started for free!</p>
                </header>
                <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="plan-card border border-slate-200 rounded-lg p-8 bg-white flex flex-col smooth-transition">
                        <h3 class="text-xl font-semibold">Starter</h3>
                        <p class="text-slate-500 mt-2">Perfect for occasional use.</p>
                        <div class="mt-6"><span class="text-4xl font-bold">₹49</span></div>
                        <ul class="mt-8 space-y-4 text-slate-600 flex-grow">
                            <li class="flex items-center"><svg class="h-5 w-5 text-green-500 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>50 Credits</li>
                        </ul>
                        <button class="buy-btn mt-8 w-full bg-slate-200 text-slate-800 font-semibold py-3 rounded-lg hover:bg-slate-300 transition" data-credits="50">Buy Now</button>
                    </div>
                    <div class="plan-card border-2 border-indigo-600 rounded-lg p-8 bg-white relative flex flex-col smooth-transition">
                        <span class="absolute top-0 -translate-y-1/2 bg-indigo-600 text-white text-xs font-semibold px-3 py-1 rounded-full">MOST POPULAR</span>
                        <h3 class="text-xl font-semibold">Pro</h3>
                        <p class="text-slate-500 mt-2">For frequent users and professionals.</p>
                        <div class="mt-6"><span class="text-4xl font-bold">₹199</span></div>
                        <ul class="mt-8 space-y-4 text-slate-600 flex-grow">
                            <li class="flex items-center"><svg class="h-5 w-5 text-green-500 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>250 Credits</li>
                            <li class="flex items-center"><svg class="h-5 w-5 text-green-500 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>Access to All Tools</li>
                        </ul>
                        <button class="buy-btn mt-8 w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition" data-credits="250">Buy Now</button>
                    </div>
                    <div class="plan-card border border-slate-200 rounded-lg p-8 bg-white flex flex-col smooth-transition">
                        <h3 class="text-xl font-semibold">Power</h3>
                        <p class="text-slate-500 mt-2">For heavy-duty tasks and teams.</p>
                        <div class="mt-6"><span class="text-4xl font-bold">₹599</span></div>
                        <ul class="mt-8 space-y-4 text-slate-600 flex-grow">
                            <li class="flex items-center"><svg class="h-5 w-5 text-green-500 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>1000 Credits</li>
                            <li class="flex items-center"><svg class="h-5 w-5 text-green-500 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>Priority Support</li>
                        </ul>
                        <button class="buy-btn mt-8 w-full bg-slate-200 text-slate-800 font-semibold py-3 rounded-lg hover:bg-slate-300 transition" data-credits="1000">Buy Now</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="generic-tool-page" class="main-section hidden pt-16 mb-20">
             <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden max-w-5xl mx-auto">
                <header class="text-center p-6 border-b border-slate-200">
                    <h1 id="generic-tool-title" class="text-3xl font-bold text-slate-900">Tool Name</h1>
                </header>
                <div class="p-12 text-center">
                    <h2 class="text-xl font-semibold text-slate-800">Feature Coming Soon!</h2>
                    <p class="mt-2 text-slate-600">We're working hard to bring this tool to you. Please check back later.</p>
                </div>
            </div>
        </section>

        <section id="content-page" class="main-section hidden pt-16 mb-20">
             <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden max-w-5xl mx-auto">
                <header class="text-center p-6 border-b border-slate-200">
                    <h1 id="content-page-title" class="text-3xl font-bold text-slate-900"></h1>
                </header>
                <div class="p-12 text-center">
                    <p class="mt-2 text-slate-600 text-lg">Our team is currently working on this page. Please check back soon for updates!</p>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="bg-white border-t border-slate-200">
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-8">
                <div class="col-span-2 lg:col-span-2">
                     <div class="flex-shrink-0 flex items-center">
                         <svg class="h-8 w-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" /></svg>
                         <span class="ml-2 text-xl font-bold text-slate-800">FileForge</span>
                    </div>
                    <p class="mt-4 text-sm text-slate-500">Your all-in-one file toolkit.</p>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-slate-900 tracking-wider uppercase">Product</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="https://anuxagfr.github.io/SwiftTools" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Home</a></li>
                        <li><a href="https://anuxagfr.github.io/SwiftTools/#features" data-title="Features" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Features</a></li>
                        <li><a href="https://anuxagfr.github.io/SwiftTools/#pricing" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Pricing</a></li>
                        <li><a href="https://anuxagfr.github.io/SwiftTools/#all-tools" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Tools</a></li>
                    </ul>
                </div>
                 <!-- Company Section Added Back -->
                 <div>
                    <h3 class="text-sm font-semibold text-slate-900 tracking-wider uppercase">Company</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="https://anuxagfr.github.io/SwiftTools/about.html" target="_blank" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">About us</a></li>
                        <li><a href="https://anuxagfr.github.io/SwiftTools/contact.html" target="_blank" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Contact us</a></li>
                        <!-- If you add a blog later, you can put the link here -->
                        <!-- <li><a href="#blog" data-title="Blog" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Blog</a></li> -->
                    </ul>
                </div>
                 <!-- Legal Section Added Back -->
                 <div>
                    <h3 class="text-sm font-semibold text-slate-900 tracking-wider uppercase">Legal</h3>
                    <ul class="mt-4 space-y-4">
                        <li><a href="https://anuxagfr.github.io/SwiftTools/privacy.html" data-title="Privacy Policy" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Privacy Policy</a></li>
                        <li><a href="https://anuxagfr.github.io/SwiftTools/terms.html" data-title="Terms & Conditions" class="footer-nav-link text-base text-slate-500 hover:text-slate-900">Terms & Conditions</a></li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 border-t border-slate-200 pt-8 text-center">
                <p class="text-base text-slate-400">&copy; 2025 FileForge. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <input type="file" id="fileUploadInput" class="hidden" multiple>
    <div id="toast"></div>

    <div id="download-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 max-w-sm w-full shadow-xl text-center">
            <h3 class="text-xl font-bold mb-2">Confirm Download</h3>
            <p class="text-slate-600 mb-6">This action will use <strong class="text-indigo-600">1 credit token</strong>. Do you want to continue?</p>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition">Cancel</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Download</button>
            </div>
        </div>
    </div>

    <div id="comingSoonModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm text-center p-6">
            <h3 class="text-lg font-semibold text-slate-800">Feature Coming Soon!</h3>
            <p class="mt-2 text-sm text-slate-600">We're working hard to bring this to you. Please check back later.</p>
            <button class="modal-close-btn mt-6 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Got it</button>
        </div>
    </div>

    <div id="authModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div id="auth-card" class="relative w-full max-w-sm mx-auto bg-white p-5 rounded-2xl shadow-lg m-4">
            <button id="close-auth-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div class="text-center mb-4">
                <h1 id="card-title" class="text-2xl font-bold text-gray-800 transition-all duration-300">Welcome Back!</h1>
                <p id="card-subtitle" class="text-gray-500 mt-2 transition-all duration-300">Please sign in to continue.</p>
            </div>
    
            <div id="login-form-container" class="form-transition">
                <form id="login-form" class="space-y-3">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <a href="#" id="forgot-password-link" class="text-sm font-medium text-blue-600 hover:text-blue-500">Forgot password?</a>
                        </div>
                        <div class="relative">
                            <input type="password" id="login-password" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"></button>
                        </div>
                    </div>
                    <div class="flex justify-center pt-2">
                        <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"></div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700">Login</button>
                    <p class="text-center text-sm text-gray-600">Don't have an account? <a href="#" class="show-signup-link font-medium text-blue-600 hover:text-blue-500">Sign up</a></p>
                </form>
            </div>
    
            <div id="signup-form-container" class="form-transition form-hidden" style="display: none;">
                <form id="signup-form" class="space-y-3">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="signup-name" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="signup-email" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Create Password</label>
                        <div class="relative">
                            <input type="password" id="signup-password" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5"></button>
                        </div>
                        <p id="signup-password-error" class="text-red-500 text-xs mt-1 hidden">Password must be at least 8 characters long.</p>
                    </div>
                     <div class="flex justify-center pt-2">
                        <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"></div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700">Create Account</button>
                    <p class="text-center text-sm text-gray-600">Already have an account? <a href="#" class="show-login-link font-medium text-blue-600 hover:text-blue-500">Login</a></p>
                </form>
            </div>
            
            <div id="forgot-form-container" class="form-transition form-hidden" style="display: none;">
                <form id="forgot-form" class="space-y-3">
                    <div>
                        <label for="forgot-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="forgot-email" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-orange-500 text-white font-semibold py-2 rounded-lg hover:bg-orange-600">Send Reset Link</button>
                    <p class="text-center text-sm text-gray-600"><a href="#" class="show-login-link font-medium text-blue-600 hover:text-blue-500">Back to Login</a></p>
                </form>
            </div>
    
            <div id="social-divider" class="my-4 flex items-center">
                <div class="flex-grow bg-gray-200 h-px"></div><span class="mx-4 text-sm text-gray-500">OR</span><div class="flex-grow bg-gray-200 h-px"></div>
            </div>
            <div id="social-login-container" class="space-y-3">
                <button id="google-auth-btn" class="w-full flex items-center justify-center bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.592,44,30.032,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>
    <div id="accountModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-semibold text-slate-800 p-4 border-b">My Account</h3>
            <div class="p-6 space-y-4">
                <div class="md:hidden border-b pb-4 mb-4 space-y-2">
                     <a href="#features" data-title="Features" class="modal-nav-link block p-2 rounded-md text-slate-700 hover:bg-slate-100 hover:text-indigo-600">Features</a>
                     <a href="https://anuxagfr.github.io/SwiftTools/about.html" data-title="About Us" class="modal-nav-link block p-2 rounded-md text-slate-700 hover:bg-slate-100 hover:text-indigo-600">About us</a>
                     <a href="https://anuxagfr.github.io/SwiftTools/contact.html" data-title="Contact Us" class="modal-nav-link block p-2 rounded-md text-slate-700 hover:bg-slate-100 hover:text-indigo-600">Contact us</a>
                </div>
                <div class="text-center">
                    <img id="account-profile-img" src="" class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-slate-200">
                    <form id="profileImageForm" class="text-sm mt-2">
                        <input type="file" id="profileImageInput" class="hidden" accept="image/*">
                        <button type="button" id="changeProfileImgBtn" class="text-indigo-600 hover:underline">Change Picture</button>
                    </form>
                </div>
                <div><strong>Name:</strong> <span id="account-name"></span></div>
                <div><strong>Email:</strong> <span id="account-email"></span></div>
                <div><strong>Credits:</strong> <span id="account-credits" class="font-bold text-indigo-600 text-lg"></span></div>
            </div>
            <div class="flex justify-between items-center gap-3 p-4 bg-slate-50 rounded-b-xl">
                <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800 font-semibold">Log Out</button>
                
                <div id="modal-auth-links" class="hidden items-center gap-2">
                    <button id="modal-login-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">Log In</button>
                    <button id="modal-signup-btn" class="text-sm bg-indigo-600 text-white font-semibold py-1.5 px-3 rounded-md hover:bg-indigo-700">Sign Up</button>
                </div>

                <button type="button" class="modal-close-btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, 
                 createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCG_OoDFWPR1viiPZ1yf4FsYPh0HH11YUc", // IMPORTANT: Keep API keys secure in production!
            authDomain: "swifttools-c0d70.firebaseapp.com",
            projectId: "swifttools-c0d70",
            storageBucket: "swifttools-c0d70.appspot.com",
            messagingSenderId: "381038178347",
            appId: "1:381038178347:web:864062cb3b39e27d6f7a6e"
        };

        const FREE_TOKENS_ON_SIGNUP = 15;
        const GUEST_CREDITS_START = 10;
        const DOWNLOAD_COST = 1;
        // const SUMMARIZE_COST = 1; // Example: Add cost for summarization if needed

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let userDocUnsubscribe = null;
        let downloadAction = null; 
        let currentGuestCredits = GUEST_CREDITS_START;

        const toastEl = document.getElementById('toast');
        const creditContainer = document.getElementById('credit-container');
        const creditCountEl = document.getElementById('credit-count');
        const authLinks = document.getElementById('auth-links');
        const profileContainer = document.getElementById('profile-container');
        const profileImg = document.getElementById('profile-img');
        const defaultAvatar = document.getElementById('default-avatar');
        const mainSections = document.querySelectorAll('.main-section');

        function showToast(message, isError = false) {
            toastEl.textContent = message;
            toastEl.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            toastEl.style.opacity = 1;
            toastEl.style.bottom = '40px';
            setTimeout(() => {
                toastEl.style.opacity = 0;
                toastEl.style.bottom = '20px';
            }, 3000);
        }

        function showMainSection(sectionId) {
            mainSections.forEach(section => {
                section.classList.toggle('hidden', section.id !== sectionId);
            });
            window.scrollTo(0, 0);
        }

        function initializeGuestCredits() {
            let credits = sessionStorage.getItem('guestCredits');
            if (credits === null) {
                currentGuestCredits = GUEST_CREDITS_START;
                sessionStorage.setItem('guestCredits', currentGuestCredits);
            } else {
                currentGuestCredits = parseInt(credits, 10);
            }
            updateGuestCreditUI();
        }
        
        function updateGuestCreditUI() {
            creditCountEl.textContent = String(currentGuestCredits).padStart(2, '0');
            sessionStorage.setItem('guestCredits', currentGuestCredits);
        }

        function updateUIForAuthState(user) {
            profileContainer.classList.remove('hidden');

            if (user) {
                authLinks.classList.add('auth-hidden');
                
                if (user.photoURL) {
                    profileImg.src = user.photoURL;
                    profileImg.classList.remove('hidden');
                    defaultAvatar.classList.add('hidden');
                } else {
                    profileImg.classList.add('hidden');
                    defaultAvatar.classList.remove('hidden');
                }
            } else {
                authLinks.classList.remove('auth-hidden');

                profileImg.classList.add('hidden');
                profileImg.src = '';
                defaultAvatar.classList.remove('hidden');
                
                initializeGuestCredits();
            }
            updateToolLocks();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.add('hidden');
        }
        
        function activateTool(toolName) {
            if (toolName.toLowerCase().includes('compress')) {
                showMainSection('compressor');
                resetUI();
                return;
            }
            document.getElementById('generic-tool-title').textContent = toolName;
            showMainSection('generic-tool-page');
        }

        onAuthStateChanged(auth, async (user) => {
            if (userDocUnsubscribe) userDocUnsubscribe();
            
            if (user) {
                sessionStorage.removeItem('guestCredits');
                currentUser = user;
                await initializeUserData(user);
            } else {
                currentUser = null;
            }
            updateUIForAuthState(user);
        });

        async function initializeUserData(user) {
            const userDocRef = doc(db, `users`, user.uid);
            userDocUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const credits = docSnap.data().credits;
                    creditCountEl.textContent = String(credits).padStart(2, '0');
                    document.getElementById('account-credits').textContent = credits;
                }
            });

            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                await setDoc(userDocRef, {
                    name: user.displayName,
                    email: user.email,
                    createdAt: new Date(),
                    credits: FREE_TOKENS_ON_SIGNUP
                });
                showToast(`Welcome! You've received ${FREE_TOKENS_ON_SIGNUP} free credits.`);
            }
        }

        async function handleEmailSignup(e) {
            e.preventDefault();
            if (grecaptcha.getResponse() === "") {
                showToast("Please complete the reCAPTCHA.", true);
                return;
            }
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            if (password.length < 8) {
                showToast("Password must be at least 8 characters.", true);
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                closeModal('authModal');
            } catch (error) { 
                showToast(error.message, true);
            } finally {
                grecaptcha.reset();
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            if (grecaptcha.getResponse() === "") {
                showToast("Please complete the reCAPTCHA.", true);
                return;
            }
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal('authModal');
            } catch (error) { 
                showToast(error.message, true);
            } finally {
                grecaptcha.reset();
            }
        }
        
        async function handlePasswordReset(e) {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            try {
                await sendPasswordResetEmail(auth, email);
                showToast(`Password reset link sent to ${email}.`);
                switchForm('login');
            } catch (error) {
                showToast(error.message, true);
            }
        }

        function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).then(() => {
                closeModal('authModal');
            }).catch(error => showToast(error.message, true));
        }

        const authModalForms = {
            login: document.getElementById('login-form-container'),
            signup: document.getElementById('signup-form-container'),
            forgot: document.getElementById('forgot-form-container')
        };
        const cardTitle = document.getElementById('card-title');
        const cardSubtitle = document.getElementById('card-subtitle');
        const socialDivider = document.getElementById('social-divider');
        const socialLogin = document.getElementById('social-login-container');

        const switchForm = (showForm) => {
            Object.values(authModalForms).forEach(form => {
                form.classList.add('form-hidden');
                setTimeout(() => form.style.display = 'none', 300);
            });
            setTimeout(() => {
                authModalForms[showForm].style.display = 'block';
                requestAnimationFrame(() => authModalForms[showForm].classList.remove('form-hidden'));
                
                const showSocials = (showForm !== 'forgot');
                socialDivider.style.display = showSocials ? 'flex' : 'none';
                socialLogin.style.display = showSocials ? 'block' : 'none';
                
                if (showForm === 'login') {
                    cardTitle.textContent = 'Welcome Back!';
                    cardSubtitle.textContent = 'Please sign in to continue.';
                } else if (showForm === 'signup') {
                    cardTitle.textContent = 'Create an Account';
                    cardSubtitle.textContent = 'Get started with a new account.';
                } else if (showForm === 'forgot') {
                    cardTitle.textContent = 'Forgot Password?';
                    cardSubtitle.textContent = "Enter your email to get a reset link.";
                }
            }, 300);
        };

        const setupPasswordFeatures = (formId) => {
            const form = document.getElementById(formId);
            if (!form) return; // Add check if form exists
            const passwordInput = form.querySelector('input[type="password"]');
            const toggleButton = form.querySelector('.password-toggle');
            const errorElement = form.querySelector('[id$="-password-error"]');
            const eyeIcon = `<svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
            const eyeSlashIcon = `<svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7-9.542-7 .847 0 1.67.127 2.452.364m-6.08 6.08a3 3 0 104.243 4.243m-4.243-4.243L8.175 8.175m6.08 6.08L18.825 18.825M12 17.75a5.75 5.75 0 005.75-5.75M12 6.25a5.75 5.75 0 015.75 5.75" /></svg>`;
            
            if (toggleButton && passwordInput) { // Check if elements exist
                toggleButton.innerHTML = eyeIcon;
                toggleButton.addEventListener('click', () => {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        toggleButton.innerHTML = eyeSlashIcon;
                    } else {
                        passwordInput.type = 'password';
                        toggleButton.innerHTML = eyeIcon;
                    }
                });
            }

            if (errorElement && passwordInput) { // Check if elements exist
                passwordInput.addEventListener('keyup', () => {
                    if (passwordInput.value.length > 0 && passwordInput.value.length < 8) {
                        errorElement.classList.remove('hidden');
                    } else {
                        errorElement.classList.add('hidden');
                    }
                });
            }
        };
        
        // --- CLOUD PICKER LOGIC ---

        // 1. Google Drive Picker (Replaced with older gapi.auth flow as requested)
        const GOOGLE_CLIENT_ID = "757396308563-krve2dgotupr2dgim1l2fmvds8ehoe7n.apps.googleusercontent.com";
        const GOOGLE_API_KEY = "AIzaSyDhyxPL2wKtE2FRMZra6ba65_2V3hqmIvo";
        const SCOPES = ['https://www.googleapis.com/auth/drive.file']; // Using 'drive.file' scope as provided

        let pickerApiLoaded = false;
        let oauthToken; // This will be set by gapi.auth

        function loadGooglePicker() {
            // Load the 'auth' and 'picker' libraries.
            gapi.load('auth', { 'callback': onAuthApiLoad });
            gapi.load('picker', { 'callback': onPickerApiLoad });
        }

        function onAuthApiLoad() {
            // This is the deprecated auth flow.
            gapi.auth.authorize({
                'client_id': GOOGLE_CLIENT_ID,
                'scope': SCOPES,
                'immediate': false
            }, handleAuthResult);
        }

        function onPickerApiLoad() { 
            pickerApiLoaded = true; 
            createPicker(); // Try to create picker (will wait for oauthToken)
        }

        function handleAuthResult(authResult) {
            if (authResult && !authResult.error) {
                oauthToken = authResult.access_token; // Store the token
                createPicker(); // Now create the picker since we have the token
            } else {
                console.error("Google Auth Error:", authResult.error);
                showToast("Google authentication failed.", true);
            }
        }

        function createPicker() {
            // Wait until both the picker API is loaded AND we have an auth token.
            if (pickerApiLoaded && oauthToken) {
                const view = new google.picker.View(google.picker.ViewId.DOCS);
                // Set mime types to filter for relevant files
                view.setMimeTypes("image/png,image/jpeg,image/jpg,application/pdf,text/plain");

                const picker = new google.picker.PickerBuilder()
                    .addView(view) // Use our configured view
                    .setOAuthToken(oauthToken) // Use the token from gapi.auth
                    .setDeveloperKey(GOOGLE_API_KEY)
                    .setCallback(pickerCallback) // Set our custom callback
                    .build();
                picker.setVisible(true);
            }
        }

        function pickerCallback(data) {
            // Use the older `data.action` check
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0]; // Use the older `data.docs` structure
                const fileId = doc.id;
                const fileName = doc.name;

                showToast(`Fetching ${fileName}...`);
                
                // Use the stored oauthToken to make a manual fetch request
                const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${oauthToken}` // Pass the token
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Google Drive fetch error: ${response.statusText} (${response.status})`);
                    }
                    const contentType = response.headers.get('content-type') || 'application/octet-stream';
                    return response.blob().then(blob => ({blob, contentType}));
                })
                .then(({blob, contentType}) => {
                    const file = new File([blob], fileName, { type: contentType });
                    handleFiles([file]); // Pass the fetched file to our app's handler
                })
                .catch(err => {
                    console.error("Google Drive fetch error: ", err);
                    showToast("Failed to download file from Google Drive.", true);
                });
            
            } else if (data.action === google.picker.Action.CANCEL) {
                showToast("Google Drive selection cancelled.");
            }
        }


        // 2. Dropbox Picker
        function launchDropboxPicker() {
            Dropbox.choose({
                success: function(files) {
                    const fileInfo = files[0];
                    // Dropbox 'direct' link should work for fetch if configured correctly
                    const url = fileInfo.link; // Use the direct link provided
                     showToast(`Fetching ${fileInfo.name}...`);
                    fetch(url) // Fetch directly from the provided link
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.blob();
                        })
                        .then(blob => {
                            // Try to infer mime type if not obvious, default if necessary
                            const mimeType = blob.type || 'application/octet-stream';
                            const file = new File([blob], fileInfo.name, { type: mimeType });
                            handleFiles([file]);
                        })
                        .catch(err => {
                            console.error("Dropbox fetch error: ", err);
                            // Provide more specific feedback if possible
                            showToast("Failed to download file from Dropbox. Check link permissions?", true);
                        });
                },
                linkType: "direct", // Request a direct download link
                multiselect: false,
                 // Add extensions filter if desired
                 // extensions: ['.pdf', '.txt', '.jpg', '.png'],
            });
        }

        // 3. OneDrive Picker - Removed

        // --- GEMINI API INTEGRATION ---
        
        /**
         * Calls the Gemini API to summarize the provided text.
         * Includes exponential backoff for retries.
         */
        async function callGeminiForSummary(textContent, retries = 3, delay = 1000) {
            const apiKey = ""; // Leave empty - handled by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: `Summarize the following text in one concise paragraph:\n\n${textContent}` }] }],
                // Optional: Add safetySettings if needed
                // safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retries > 0) {
                     // Throttled - retry with exponential backoff
                     console.warn(`Gemini API throttled. Retrying in ${delay / 1000}s... (${retries} retries left)`);
                     await new Promise(resolve => setTimeout(resolve, delay));
                     return callGeminiForSummary(textContent, retries - 1, delay * 2);
                 }


                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`Gemini API request failed: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                // Navigate the response structure to get the text
                 const candidate = result.candidates?.[0];
                 const summaryText = candidate?.content?.parts?.[0]?.text;

                 if (!summaryText) {
                     console.error("Unexpected Gemini API response structure:", result);
                     throw new Error("Could not extract summary from Gemini response.");
                 }

                return summaryText.trim();

            } catch (error) {
                 if (retries > 0 && (error.message.includes('Failed to fetch') || error.message.includes('network error'))) {
                    // Network error - retry with exponential backoff
                     console.warn(`Network error calling Gemini API. Retrying in ${delay / 1000}s... (${retries} retries left)`);
                     await new Promise(resolve => setTimeout(resolve, delay));
                     return callGeminiForSummary(textContent, retries - 1, delay * 2);
                 } else {
                     console.error("Error calling Gemini API:", error);
                     return "Error: Could not generate summary."; // Return error message for UI
                 }
            }
        }


        /**
         * Handles the click event for the Summarize button.
         */
        async function handleSummarizeClick(file) {
            const summaryArea = document.getElementById('summaryArea');
            const summarizeBtn = document.getElementById('summarizeBtn');
            if (!summaryArea || !summarizeBtn) return;

            // Optional: Check credits before proceeding
            // const canProceed = await useCredits(SUMMARIZE_COST);
            // if (!canProceed) return;

            summarizeBtn.disabled = true;
            summaryArea.innerHTML = `<p class="text-sm text-slate-500 animate-pulse">✨ Generating summary...</p>`;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const fileContent = e.target.result;
                const summary = await callGeminiForSummary(fileContent);
                 summaryArea.innerHTML = `
                     <h3 class="text-md font-semibold mb-1 text-slate-700">✨ Summary:</h3>
                     <p class="text-sm text-slate-600 bg-slate-50 p-3 rounded border">${summary}</p>
                 `;
                 // No need to re-enable button if it's a one-time action per upload
            };
            reader.onerror = () => {
                 summaryArea.innerHTML = `<p class="text-sm text-red-600">Error reading file content.</p>`;
                 summarizeBtn.disabled = false; // Re-enable on error
            };
            reader.readAsText(file); // Read file as text
        }


        // --- EVENT LISTENERS ---
        document.getElementById('loginBtn')?.addEventListener('click', () => { switchForm('login'); document.getElementById('authModal').classList.remove('hidden'); });
        document.getElementById('signupBtn')?.addEventListener('click', () => { switchForm('signup'); document.getElementById('authModal').classList.remove('hidden'); });
        document.getElementById('close-auth-modal-btn')?.addEventListener('click', () => closeModal('authModal'));
        document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal')?.classList.add('hidden'))); // Added null check
        
        document.getElementById('modal-login-btn')?.addEventListener('click', () => { // Added null check
            closeModal('accountModal');
            switchForm('login');
            document.getElementById('authModal').classList.remove('hidden');
        });
        document.getElementById('modal-signup-btn')?.addEventListener('click', () => { // Added null check
            closeModal('accountModal');
            switchForm('signup');
            document.getElementById('authModal').classList.remove('hidden');
        });

        document.getElementById('login-form')?.addEventListener('submit', handleEmailLogin); // Added null check
        document.getElementById('signup-form')?.addEventListener('submit', handleEmailSignup); // Added null check
        document.getElementById('forgot-form')?.addEventListener('submit', handlePasswordReset); // Added null check

        document.getElementById('google-auth-btn')?.addEventListener('click', handleGoogleSignIn); // Added null check
        
        document.querySelector('.show-signup-link')?.addEventListener('click', (e) => { e.preventDefault(); switchForm('signup'); }); // Added null check
        document.getElementById('forgot-password-link')?.addEventListener('click', (e) => { e.preventDefault(); switchForm('forgot'); }); // Added null check
        document.querySelectorAll('.show-login-link').forEach(link => {
            link.addEventListener('click', (e) => { e.preventDefault(); switchForm('login'); });
        });
        
        profileContainer.addEventListener('click', () => {
            const modalAuthLinks = document.getElementById('modal-auth-links');
             const accountNameEl = document.getElementById('account-name');
             const accountEmailEl = document.getElementById('account-email');
             const accountCreditsEl = document.getElementById('account-credits');
             const accountProfileImgEl = document.getElementById('account-profile-img');
             const profileImageFormEl = document.getElementById('profileImageForm');
             const logoutBtnEl = document.getElementById('logoutBtn');


             if (!currentUser) {
                 if (accountNameEl) accountNameEl.textContent = 'Guest';
                 if (accountEmailEl) accountEmailEl.textContent = 'Please log in';
                 if (accountCreditsEl) accountCreditsEl.textContent = currentGuestCredits;
                 if (accountProfileImgEl) accountProfileImgEl.src = `https://ui-avatars.com/api/?name=Guest&background=random&color=fff`;
                 if (profileImageFormEl) profileImageFormEl.style.display = 'none';
                 if (logoutBtnEl) logoutBtnEl.style.display = 'none';
                 if (modalAuthLinks) {
                    modalAuthLinks.classList.remove('hidden');
                    modalAuthLinks.classList.add('flex');
                 }
            } else {
                 if (accountNameEl) accountNameEl.textContent = currentUser.displayName || 'N/A';
                 if (accountEmailEl) accountEmailEl.textContent = currentUser.email;
                 const profilePic = accountProfileImgEl;
                 if (profilePic) {
                    const placeholderUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.email)}&background=random&color=fff`;
                    profilePic.src = currentUser.photoURL || placeholderUrl;
                 }
                 
                const isProviderUser = currentUser.providerData.some(provider => provider.providerId !== 'password');
                 if (profileImageFormEl) profileImageFormEl.style.display = isProviderUser ? 'none' : 'block';
                 if (logoutBtnEl) logoutBtnEl.style.display = 'block';
                 if (modalAuthLinks) {
                    modalAuthLinks.classList.add('hidden');
                    modalAuthLinks.classList.remove('flex');
                 }
            }
             const accountModal = document.getElementById('accountModal');
             if (accountModal) accountModal.classList.remove('hidden');
        });
        
        document.getElementById('accountModal')?.addEventListener('click', (e) => { // Added null check
            const link = e.target.closest('.modal-nav-link');
            if (!link) return;

            e.preventDefault();
            const pageTitle = link.dataset.title;
            const targetUrl = link.getAttribute('href'); // Get href for external links

            if (targetUrl && !targetUrl.startsWith('#')) {
                 window.open(targetUrl, '_blank'); // Open external links in new tab
            } else if (pageTitle) {
                const titleEl = document.getElementById('content-page-title');
                 if (titleEl) titleEl.textContent = pageTitle;
                showMainSection('content-page');
            }
            
            closeModal('accountModal');
        });

        document.getElementById('logoutBtn')?.addEventListener('click', () => { // Added null check
            sessionStorage.removeItem('guestCredits');
            signOut(auth);
            closeModal('accountModal');
        });

        document.getElementById('changeProfileImgBtn')?.addEventListener('click', (e) => { // Added null check
            e.preventDefault();
            document.getElementById('profileImageInput')?.click(); // Added null check
        });

        document.getElementById('profileImageInput')?.addEventListener('change', async (e) => { // Added null check
            const file = e.target.files[0];
            if (!file || !currentUser) return;
            showToast('Uploading image...');
            const storageRef = ref(storage, `profile-images/${currentUser.uid}`);
            try {
                await uploadBytes(storageRef, file);
                const photoURL = await getDownloadURL(storageRef);
                await updateProfile(currentUser, { photoURL });
                 const accProfileImg = document.getElementById('account-profile-img');
                 if (accProfileImg) accProfileImg.src = photoURL;
                 if (profileImg) profileImg.src = photoURL; // Update nav profile pic too
                showToast('Profile picture updated!');
            } catch (error) {
                showToast('Failed to upload image.', true);
                console.error(error);
            }
        });
        
        async function useCredits(cost) {
            if (currentUser) {
                const userDocRef = doc(db, 'users', currentUser.uid);
                try { // Add try-catch for Firestore operations
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().credits >= cost) {
                        await updateDoc(userDocRef, { credits: increment(-cost) });
                        return true;
                    } else {
                        showToast("Not enough credits! Please buy a pack.", true); 
                        showMainSection('pricing'); 
                        return false;
                    }
                } catch (error) {
                    console.error("Firestore error in useCredits:", error);
                    showToast("Error checking/updating credits.", true);
                    return false;
                }
            } else {
                if (currentGuestCredits >= cost) {
                    currentGuestCredits -= cost;
                    updateGuestCreditUI();
                    return true;
                } else {
                    showToast("Not enough credits! Please log in for more.", true);
                    const authModal = document.getElementById('authModal');
                    if (authModal) authModal.classList.remove('hidden');
                    switchForm('login');
                    return false;
                }
            }
        }
        
        document.getElementById('modal-confirm-btn')?.addEventListener('click', async () => { // Added null check
             const success = await useCredits(DOWNLOAD_COST);
             if (success) {
                 showToast(`${DOWNLOAD_COST} credit used. Starting download...`);
                 if (typeof downloadAction === 'function') {
                      downloadAction();
                 }
             }
             closeModal('download-modal');
        });
        document.getElementById('modal-cancel-btn')?.addEventListener('click', () => closeModal('download-modal')); // Added null check

        function promptForDownload(fileName, blob) {
            downloadAction = () => {
                try { // Add error handling for blob URL creation
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href); // Clean up blob URL
                } catch (error) {
                    console.error("Error creating download link:", error);
                    showToast("Could not initiate download.", true);
                }
            };
            const downloadModal = document.getElementById('download-modal');
            if (downloadModal) downloadModal.classList.remove('hidden');
        }

        document.querySelectorAll('.buy-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (!currentUser) {
                    showToast("Please log in to buy credits.", true);
                    const authModal = document.getElementById('authModal');
                    if (authModal) authModal.classList.remove('hidden');
                    switchForm('login');
                    return;
                }
                
                const creditsToAdd = parseInt(e.currentTarget.dataset.credits, 10); // Changed to increment
                const userDocRef = doc(db, 'users', currentUser.uid);
                
                try {
                     // Simulate purchase by incrementing credits
                     await updateDoc(userDocRef, { credits: increment(creditsToAdd) }); 
                    showToast(`Purchase successful! ${creditsToAdd} credits added.`);
                } catch (error) {
                    showToast("An error occurred during purchase simulation.", true);
                    console.error("Credit purchase simulation error: ", error);
                }
            });
        });

        const uploadSelection = document.getElementById('uploadSelection');
        const processingArea = document.getElementById('processingArea');
        const uploadArea = document.getElementById('uploadArea');
        const fileUploadInput = document.getElementById('fileUploadInput');
        let currentFiles = [];
        let compressionResults = [];
        let processedFileCount = 0;

        function handleFiles(files) {
             // Basic validation
             const validFiles = Array.from(files).filter(file => file.size > 0);
             if (validFiles.length !== files.length) {
                 showToast("Some files were empty and have been ignored.", true);
             }
             if (validFiles.length === 0) {
                 showToast("No valid files selected.", true);
                 return;
             }

             // Only add new, valid files
             const newFiles = validFiles.filter(vf => !currentFiles.some(cf => cf.name === vf.name && cf.size === vf.size && cf.lastModified === vf.lastModified));
             if (newFiles.length === 0 && currentFiles.length > 0) {
                 showToast("Selected files are already added.", true);
                 return; // Avoid adding duplicates if files already exist
             }

            currentFiles.push(...newFiles);
            compressionResults = new Array(currentFiles.length).fill(null); // Resize results array
            renderProcessingUI();
        }

        function renderProcessingUI() {
            if (currentFiles.length === 0) {
                resetUI();
                return;
            }
             if (!uploadSelection || !processingArea) return; // Add null checks
            uploadSelection.classList.add('hidden');
            processingArea.classList.remove('hidden');
            if (currentFiles.length === 1) {
                showSingleFileUI(currentFiles[0]);
            } else {
                showBatchUI();
            }
        }

        function showSingleFileUI(file) {
            if (!processingArea) return; // Add null check

            let previewHTML = '';
            // Generate preview URL safely
            try {
                 if (file.type.startsWith('image/')) {
                     const objectURL = URL.createObjectURL(file);
                     previewHTML = `<img src="${objectURL}" alt="File preview" class="max-h-48 w-auto object-contain rounded-md mx-auto" onload="URL.revokeObjectURL(this.src)">`; // Revoke URL after load
                 } else {
                     previewHTML = `<div class="text-8xl text-center py-10">📄</div>`; // Generic icon
                 }
            } catch (error) {
                console.error("Error creating object URL for preview:", error);
                previewHTML = `<div class="text-slate-500 text-sm">Preview unavailable</div>`;
            }
            
            const isTextFile = file.type === 'text/plain';
            const summarizeSectionHTML = isTextFile ? `
                <div class="mt-6 pt-6 border-t">
                     <button id="summarizeBtn" class="w-full flex items-center justify-center text-center p-3 bg-purple-600 text-white rounded-lg shadow-sm hover:bg-purple-700 font-semibold text-sm">
                         ✨ Summarize Content
                     </button>
                     <div id="summaryArea" class="mt-4"></div>
                 </div>
            ` : '';
            
            processingArea.innerHTML = `
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-4 text-center md:text-left">
                        <h2 class="text-xl font-bold text-slate-800">Your File</h2>
                        <div class="bg-slate-50 p-4 rounded-lg border min-h-[100px] flex items-center justify-center">${previewHTML}</div>
                        <div class="text-sm">
                            <p class="font-semibold truncate" title="${file.name}">${file.name}</p>
                            <p class="text-slate-500">${formatBytes(file.size)}</p>
                        </div>
                        <button id="resetBtn" class="w-full md:w-auto bg-white hover:bg-slate-100 border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg text-sm">Start Over</button>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Compression Options</h2>
                            <!-- Compression levels might be less relevant for simple Gzip -->
                             <p class="text-sm text-slate-500 mt-2">Files will be compressed using Gzip.</p>
                             <!-- Removed compression level selection for simplicity with Gzip -->
                        </div>
                         <!-- Manual size input removed as it's complex for Gzip -->
                        <div>
                             <button id="compressBtn" class="w-full mt-4 flex items-center justify-center text-center p-4 bg-indigo-600 text-white rounded-lg shadow-sm hover:bg-indigo-700 font-semibold text-lg">Compress File</button>
                        </div>
                         ${summarizeSectionHTML} 
                    </div>
                </div>
                <div id="resultArea" class="mt-8"></div>
            `;
            addProcessingEventListeners(); // Re-attach listeners after modifying innerHTML
             if (isTextFile) {
                 document.getElementById('summarizeBtn')?.addEventListener('click', () => handleSummarizeClick(file));
             }
        }


        function showBatchUI() {
             if (!processingArea) return; // Add null check
            const fileListHTML = currentFiles.map((file, index) => `
                <div id="file-row-${index}" class="p-2 grid grid-cols-5 gap-2 items-center text-sm border-b last:border-b-0">
                    <div class="flex items-center gap-2 col-span-3">
                        <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-slate-200 rounded-md text-xl">📄</div>
                        <div class="min-w-0 flex-1"><p class="font-semibold truncate" title="${file.name}">${file.name}</p><p class="text-slate-500 text-xs">${formatBytes(file.size)}</p></div>
                    </div>
                    <div id="file-result-${index}" class="col-span-2 text-right"><span class="text-slate-400 text-xs">Pending...</span></div>
                </div>`).join('');

            processingArea.innerHTML = `
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-bold text-slate-800">Your Files (${currentFiles.length})</h2>
                            <div class="flex gap-2">
                                 <button id="addMoreBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">Add More</button>
                                 <button id="clearAllBtn" class="text-sm text-red-600 hover:text-red-800 font-semibold">Clear All</button>
                            </div>
                        </div>
                        <div class="bg-white border rounded-lg max-h-96 overflow-y-auto">${fileListHTML}</div>
                        <div id="zipDownloadArea" class="mt-4 text-center"></div>
                    </div>
                    <div class="space-y-6">
                        <h2 class="text-xl font-bold text-slate-800">Compression Options</h2>
                         <p class="text-sm text-slate-500 mt-2">Files will be compressed using Gzip.</p>
                         <!-- Removed compression level selection -->
                        <div><button id="compressBtn" class="w-full mt-4 p-4 bg-indigo-600 text-white rounded-lg shadow-sm hover:bg-indigo-700 font-semibold text-lg">Compress All (${currentFiles.length}) Files</button></div>
                    </div>
                </div>`;
            addProcessingEventListeners(); // Re-attach listeners
        }

        function showSingleResult(originalFile, compressedBlob) {
            const resultArea = document.getElementById('resultArea');
            if (!resultArea) return; // Add null check
            const downloadBtnId = `download-btn-${Date.now()}`;
             // Calculate savings safely, avoid division by zero
             const savings = originalFile.size > 0 ? (100 - (compressedBlob.size / originalFile.size * 100)) : 0;

            resultArea.innerHTML = `<div class="bg-green-50 border-dashed border-2 border-green-200 rounded-xl p-6">
                <h3 class="text-xl font-bold text-green-800 text-center">Compression Complete!</h3>
                <div class="flex flex-wrap justify-center gap-4 my-4 text-sm text-center">
                    <div><div class="text-slate-500 text-xs">Original</div><div class="font-bold text-base">${formatBytes(originalFile.size)}</div></div>
                    <div><div class="text-slate-500 text-xs">Compressed</div><div class="font-bold text-base text-green-700">${formatBytes(compressedBlob.size)}</div></div>
                    <div><div class="text-slate-500 text-xs">Savings</div><div class="font-bold text-base text-green-700">${savings.toFixed(1)}%</div></div>
                </div>
                <div class="text-center mt-4"><button id="${downloadBtnId}" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Download File (1 Credit)</button></div>
            </div>`;
             const downloadButton = document.getElementById(downloadBtnId);
             if (downloadButton) {
                downloadButton.onclick = () => promptForDownload(getCompressedFileName(originalFile.name), compressedBlob);
             }
             const compressButton = document.getElementById('compressBtn');
             if (compressButton) {
                compressButton.disabled = true;
                compressButton.textContent = 'Completed';
             }
        }

        function updateFileResultInList(index, originalFile, compressedBlob) {
            const resultContainer = document.getElementById(`file-result-${index}`);
             if (!resultContainer) return; // Add null check

             // Calculate savings safely
             const savings = originalFile.size > 0 ? (100 - (compressedBlob.size / originalFile.size * 100)) : 0;
            compressionResults[index] = { name: getCompressedFileName(originalFile.name), compressedBlob };

            resultContainer.innerHTML = `<div class="flex items-center justify-end gap-1">
                <div class="text-right">
                    <p class="font-semibold text-green-700 text-xs">${formatBytes(compressedBlob.size)}</p>
                    <p class="text-xs text-green-600">${savings.toFixed(1)}% Saved</p>
                </div>
                <button data-index="${index}" title="Download this file" class="download-single-btn p-1 rounded-md hover:bg-slate-100 flex-shrink-0"><svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></button>
            </div>`;
            
            processedFileCount++;
             const compressButton = document.getElementById('compressBtn');
             const zipDownloadArea = document.getElementById('zipDownloadArea');
            if (processedFileCount === currentFiles.length) {
                 if (compressButton) {
                    compressButton.disabled = true;
                    compressButton.textContent = 'All Files Completed';
                 }
                 if (zipDownloadArea) {
                     // Add check to ensure there are results before showing download all
                     const hasResults = compressionResults.some(r => r && r.compressedBlob);
                     if (hasResults) {
                         zipDownloadArea.innerHTML = `<button id="downloadZipBtn" class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700">Download All as .ZIP (1 Credit)</button>`;
                         document.getElementById('downloadZipBtn')?.addEventListener('click', createAndDownloadZip);
                     } else {
                         zipDownloadArea.innerHTML = `<p class="text-sm text-red-500">Compression failed for all files.</p>`;
                     }
                 }
            } else {
                 // Update button text during progress
                 if (compressButton) {
                     compressButton.innerHTML = `<span class="animate-pulse">Compressing ${processedFileCount + 1}/${currentFiles.length}...</span>`;
                 }
            }

            // Re-attach listener specifically to the new button
             const newDownloadButton = resultContainer.querySelector('.download-single-btn');
             if (newDownloadButton) {
                 newDownloadButton.onclick = (e) => {
                     const idx = e.currentTarget.dataset.index;
                     if (compressionResults[idx]) {
                         const { name, compressedBlob } = compressionResults[idx];
                         promptForDownload(name, compressedBlob);
                     }
                 };
             }
        }
        
        function resetUI() {
            currentFiles = [];
            compressionResults = [];
            processedFileCount = 0;
            if (fileUploadInput) fileUploadInput.value = ''; // Check exists
            if (uploadSelection) uploadSelection.classList.remove('hidden'); // Check exists
            if (processingArea) { // Check exists
                 processingArea.classList.add('hidden');
                 processingArea.innerHTML = ''; // Clear previous content
            }
        }
        
        function addProcessingEventListeners() {
            // Use optional chaining for robustness
            document.getElementById('resetBtn')?.addEventListener('click', resetUI);
            document.getElementById('clearAllBtn')?.addEventListener('click', resetUI);
            document.getElementById('addMoreBtn')?.addEventListener('click', () => fileUploadInput?.click());
            document.getElementById('compressBtn')?.addEventListener('click', processCompression);
        }


        function getCompressedFileName(originalName) {
            // Handle names without extensions more robustly
            const dotIndex = originalName.lastIndexOf('.');
            const name = dotIndex > 0 ? originalName.substring(0, dotIndex) : originalName; // Use > 0 to handle hidden files like .bashrc
             // Basic sanitization: remove potentially problematic characters for filenames
             const sanitizedName = name.replace(/[^a-zA-Z0-9\-_.]/g, '_');
            return `${sanitizedName}.gz`;
        }

        function processCompression() {
             if (!currentFiles || currentFiles.length === 0) {
                 showToast("No files to compress.", true);
                 return;
             }
             // Disable buttons during processing
             const compressBtn = document.getElementById('compressBtn');
             if(compressBtn) compressBtn.disabled = true;
             const addMoreBtn = document.getElementById('addMoreBtn');
             if(addMoreBtn) addMoreBtn.disabled = true;
             const clearAllBtn = document.getElementById('clearAllBtn');
             if(clearAllBtn) clearAllBtn.disabled = true;


             if (currentFiles.length === 1) processSingleFileCompression();
             else processBatchCompression();
        }

        async function processSingleFileCompression() {
            const compressBtn = document.getElementById('compressBtn');
             if (compressBtn) compressBtn.innerHTML = '<span class="animate-pulse">Compressing...</span>';
            const file = currentFiles[0];
             if (!file) {
                 resetUI(); // Reset if file somehow becomes invalid
                 return;
             }

            const reader = new FileReader();
            reader.onload = (e) => {
                 try {
                     const fileContent = e.target.result;
                     if (!(fileContent instanceof ArrayBuffer)) {
                         throw new Error("File reader did not return ArrayBuffer.");
                     }
                     const compressed = pako.gzip(new Uint8Array(fileContent));
                     const blob = new Blob([compressed], { type: 'application/gzip' }); // Specify mime type
                     showSingleResult(file, blob);
                 } catch (error) {
                     console.error("Compression error:", error);
                     showToast(`Error compressing ${file.name}.`, true);
                     // Update UI to show error for this file
                     const resultArea = document.getElementById('resultArea');
                     if(resultArea) resultArea.innerHTML = `<p class="text-red-500 text-sm">Compression failed.</p>`;
                     if(compressBtn) compressBtn.textContent = 'Compression Failed'; // Keep disabled but show status
                 }
            };
            reader.onerror = (e) => {
                 console.error("File reading error:", e);
                 showToast(`Error reading ${file.name}.`, true);
                 const resultArea = document.getElementById('resultArea');
                 if(resultArea) resultArea.innerHTML = `<p class="text-red-500 text-sm">Error reading file.</p>`;
                 if(compressBtn) compressBtn.textContent = 'File Read Error';
            };
            reader.readAsArrayBuffer(file);
        }

        async function processBatchCompression() {
            const compressBtn = document.getElementById('compressBtn');
            if (compressBtn) compressBtn.innerHTML = '<span class="animate-pulse">Compressing 1/'+ currentFiles.length + '...</span>';
            processedFileCount = 0; // Reset count for batch

            // Use Promise.all to handle all files concurrently but wait for all
             const compressionPromises = currentFiles.map((file, index) => {
                 return new Promise((resolve) => {
                     const resultContainer = document.getElementById(`file-result-${index}`);
                     if (resultContainer) resultContainer.innerHTML = `<span class="text-indigo-500 animate-pulse text-xs">...</span>`;

                     const reader = new FileReader();
                     reader.onload = (e) => {
                         try {
                             const fileContent = e.target.result;
                             if (!(fileContent instanceof ArrayBuffer)) {
                                 throw new Error("File reader did not return ArrayBuffer.");
                             }
                             const compressed = pako.gzip(new Uint8Array(fileContent));
                             const blob = new Blob([compressed], { type: 'application/gzip' });
                             updateFileResultInList(index, file, blob);
                             resolve(true); // Indicate success for this file
                         } catch (error) {
                             console.error(`Compression error for ${file.name}:`, error);
                             if (resultContainer) resultContainer.innerHTML = `<span class="text-red-500 text-xs">Failed</span>`;
                             processedFileCount++; // Still increment count on failure
                             resolve(false); // Indicate failure
                         }
                     };
                     reader.onerror = (e) => {
                         console.error(`File reading error for ${file.name}:`, e);
                         if (resultContainer) resultContainer.innerHTML = `<span class="text-red-500 text-xs">Read Err</span>`;
                         processedFileCount++; // Increment count on read error
                         resolve(false); // Indicate failure
                     };
                     reader.readAsArrayBuffer(file);
                 });
             });

             // Wait for all file processing attempts to complete
             await Promise.all(compressionPromises);

             // Final check after all promises are settled (needed if last file fails)
             if (processedFileCount === currentFiles.length) {
                  const zipDownloadArea = document.getElementById('zipDownloadArea');
                  if (zipDownloadArea && !zipDownloadArea.hasChildNodes()) { // Check if download button wasn't added
                      const hasResults = compressionResults.some(r => r && r.compressedBlob);
                      if (hasResults) {
                         zipDownloadArea.innerHTML = `<button id="downloadZipBtn" class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700">Download All as .ZIP (1 Credit)</button>`;
                         document.getElementById('downloadZipBtn')?.addEventListener('click', createAndDownloadZip);
                      } else {
                         zipDownloadArea.innerHTML = `<p class="text-sm text-red-500">Compression failed for all files.</p>`;
                      }
                  }
                 if (compressBtn && compressBtn.textContent.includes('Compressing')) { // Check if still showing progress
                     compressBtn.textContent = 'Finished (with errors)';
                     compressBtn.disabled = true;
                 }
                 // Re-enable add/clear buttons after completion (even with errors)
                 const addMoreBtn = document.getElementById('addMoreBtn');
                 if(addMoreBtn) addMoreBtn.disabled = false;
                 const clearAllBtn = document.getElementById('clearAllBtn');
                 if(clearAllBtn) clearAllBtn.disabled = false;

             }
        }
        
        async function createAndDownloadZip() {
             const zipButton = document.getElementById('downloadZipBtn');
             if(zipButton) zipButton.disabled = true; // Prevent multiple clicks
             showToast("Creating ZIP file...");

            const zip = new JSZip();
             let filesAdded = 0;
            compressionResults.forEach(result => {
                if (result && result.compressedBlob) {
                    // Basic sanitization for filenames within zip
                    const safeName = result.name.replace(/[^a-zA-Z0-9\-_.]/g, '_');
                    zip.file(safeName, result.compressedBlob);
                     filesAdded++;
                }
            });

             if (filesAdded === 0) {
                 showToast("No compressed files to add to ZIP.", true);
                 if(zipButton) zipButton.disabled = false;
                 return;
             }

             try {
                 const zipBlob = await zip.generateAsync({
                     type: "blob",
                     compression: "DEFLATE", // Add compression to the zip container itself
                     compressionOptions: { level: 6 }
                  });
                 promptForDownload('FileForge-Compressed.zip', zipBlob);
             } catch (error) {
                 console.error("Error generating ZIP:", error);
                 showToast("Failed to create ZIP file.", true);
             } finally {
                 if(zipButton) zipButton.disabled = false; // Re-enable button
             }
        }

        const formatBytes = (bytes, decimals = 2) => {
            if (!Number.isFinite(bytes) || bytes < 0) return 'Invalid size'; // Add validation
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; // Add TB
            const i = Math.min(Math.floor(Math.log(bytes) / Math.log(k)), sizes.length - 1); // Prevent index out of bounds
            return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals < 0 ? 0 : decimals)) + ' ' + sizes[i];
        };

        // Ensure elements exist before adding listeners
        uploadArea?.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-area-highlight'); });
        uploadArea?.addEventListener('dragleave', () => uploadArea.classList.remove('drag-area-highlight'));
        uploadArea?.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('drag-area-highlight'); handleFiles(e.dataTransfer.files); });
        document.getElementById('deviceBtn')?.addEventListener('click', () => fileUploadInput?.click());
        fileUploadInput?.addEventListener('change', (e) => handleFiles(e.target.files));
        
        document.getElementById('urlBtn')?.addEventListener('click', () => document.getElementById('comingSoonModal')?.classList.remove('hidden'));
        document.getElementById('driveBtn')?.addEventListener('click', loadGooglePicker);
        document.getElementById('dropboxBtn')?.addEventListener('click', launchDropboxPicker);
        // OneDrive listener removed
        
        document.getElementById('clipboardBtn')?.addEventListener('click', async () => {
            if (!navigator.clipboard || !navigator.clipboard.read) {
                 showToast("Clipboard API not supported or permission denied.", true);
                 return;
            }
            try {
                const clipboardItems = await navigator.clipboard.read();
                let found = false;
                for (const item of clipboardItems) {
                    const imageType = item.types.find(type => type.startsWith('image/'));
                    if (imageType) {
                        const blob = await item.getType(imageType);
                         // Create a more descriptive filename if possible
                         const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        const file = new File([blob], `pasted-image-${timestamp}.png`, { type: blob.type });
                        handleFiles([file]);
                        found = true;
                        break;
                    }
                }
                if (!found) showToast('No image found on clipboard.', true);
            } catch (err) {
                console.error('Clipboard error:', err);
                 // Check for specific error types if needed (e.g., NotAllowedError)
                showToast('Could not read from clipboard. Permission might be needed.', true);
            }
        });

        const toolData = [
             // ... (tool data remains the same) ...
              { name: 'Compress PDF', category: 'Compress', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" /></svg>', color: 'bg-red-500' },
             { name: 'PDF Converter', category: 'Convert', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>', color: 'bg-red-500' },
             { name: 'AI PDF Assistant', category: 'AI PDF', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z" /></svg>', color: 'bg-blue-500', isPremium: true },
             { name: 'Chat with PDF', category: 'AI PDF', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12c0 4.556-4.03 8.25-9 8.25a9.76 9.76 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" /></svg>', color: 'bg-blue-500', isPremium: true },
             { name: 'Merge PDF', category: 'Organize', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5m-16.5-1.5a1.5 1.5 0 0 1-1.5-1.5V6.75A1.5 1.5 0 0 1 3.75 5.25h16.5a1.5 1.5 0 0 1 1.5 1.5v10.5a1.5 1.5 0 0 1-1.5 1.5H3.75Z" /></svg>', color: 'bg-purple-500' },
             { name: 'Split PDF', category: 'Organize', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m-4.875-6.375h9.75" /><path d="M19.5 21a2.25 2.25 0 0 0 2.25-2.25V5.25A2.25 2.25 0 0 0 19.5 3H4.5A2.25 2.25 0 0 0 2.25 5.25v13.5A2.25 2.25 0 0 0 4.5 21h15Z" /></svg>', color: 'bg-purple-500' },
             { name: 'PDF to Word', category: 'Convert from PDF', icon: '<div class="font-bold text-lg">W</div>', color: 'bg-blue-600' },
             { name: 'Sign PDF', category: 'Sign', icon: '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Z" /></svg>', color: 'bg-pink-500' }
        ];
        
        function updateToolLocks() {
            document.querySelectorAll('.tool-link[data-premium="true"]').forEach(link => {
                if (currentUser) {
                    link.classList.remove('locked');
                    link.title = ""; // Clear title when unlocked
                } else {
                    link.classList.add('locked');
                    link.title = "Login required to use this premium tool"; // Add informative title
                }
            });
        }

        function renderTools() {
            const container = document.getElementById('all-tools-container');
             if (!container) return; // Add null check
            const groupedTools = toolData.reduce((acc, tool) => {
                (acc[tool.category] = acc[tool.category] || []).push(tool);
                return acc;
            }, {});

            container.innerHTML = Object.entries(groupedTools).map(([category, tools]) => `
                <div class="mb-12">
                    <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">${category}</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${tools.map(tool => {
                            const isPremium = tool.isPremium || false;
                             const lockIcon = isPremium ? `<span class="premium-lock absolute top-2 right-2 text-slate-400 p-1 bg-white/70 backdrop-blur-sm rounded-full shadow"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 0 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" /></svg></span>` : '';
                            
                            return `
                            <a href="#" class="tool-link relative flex items-center gap-4 p-4 rounded-lg hover:bg-slate-100 border bg-white smooth-transition shadow-sm hover:shadow-md" data-tool="${tool.name}" data-premium="${isPremium}">
                                ${lockIcon}
                                <div class="flex-shrink-0 h-12 w-12 flex items-center justify-center ${tool.color} rounded-lg text-white shadow-inner">
                                    ${tool.icon}
                                </div>
                                <span class="font-semibold text-slate-700 text-sm">${tool.name}</span>
                            </a>
                            `
                        }).join('')}
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.tool-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = e.currentTarget;
                    const toolName = target.dataset.tool;
                    const isPremium = target.dataset.premium === 'true';

                    if (isPremium && !currentUser) {
                        showToast("Please log in to use premium features.", true);
                        const authModal = document.getElementById('authModal');
                        if (authModal) authModal.classList.remove('hidden');
                        switchForm('login');
                    } else {
                        activateTool(toolName);
                    }
                });
            });
            
            updateToolLocks(); // Initial lock state update
        }
        
        // Initial setup calls
        document.getElementById('homeLink')?.addEventListener('click', (e) => { e.preventDefault(); showMainSection('home'); });
        document.getElementById('compressorLinkNav')?.addEventListener('click', (e) => { e.preventDefault(); showMainSection('compressor'); resetUI(); });
        document.getElementById('allToolsLinkNav')?.addEventListener('click', (e) => { e.preventDefault(); showMainSection('all-tools'); });
        document.getElementById('pricingLinkNav')?.addEventListener('click', (e) => { e.preventDefault(); showMainSection('pricing'); });
        document.getElementById('homeGetStartedBtn')?.addEventListener('click', (e) => { e.preventDefault(); showMainSection('compressor'); });
        
         const footer = document.querySelector('footer');
         if (footer) {
             footer.addEventListener('click', (e) => {
                 const link = e.target.closest('.footer-nav-link');
                 if (!link) return;

                 e.preventDefault();
                 const sectionId = link.getAttribute('href')?.substring(1); // Use optional chaining
                 const pageTitle = link.dataset.title;
                 const targetUrl = link.getAttribute('href');

                 if (targetUrl && !targetUrl.startsWith('#')) {
                      window.open(targetUrl, '_blank'); // Open external links
                 } else if (pageTitle) {
                      const titleEl = document.getElementById('content-page-title');
                      if(titleEl) titleEl.textContent = pageTitle;
                     showMainSection('content-page');
                 } else if (sectionId) { // Check if sectionId is valid
                     const section = document.getElementById(sectionId);
                     if (section) {
                         showMainSection(sectionId);
                     } else {
                          console.warn(`Footer link target section not found: #${sectionId}`);
                     }
                 }
             });
         }
        
         // Initialize Google API client library for Picker - This is now handled by loadGooglePicker
         /*
         gapi.load('client:picker', () => {
             console.log("Google Picker API library loaded.");
             // No immediate initialization needed here, happens on button click
         });
         */
         // GSI script loader removed as it's not used by gapi.auth.authorize
         /*
         const gsiScript = document.createElement('script');
         gsiScript.src = 'https://accounts.google.com/gsi/client';
         gsiScript.async = true;
         gsiScript.defer = true;
         document.head.appendChild(gsiScript);
        */

        showMainSection('home'); // Show home section initially
        renderTools(); // Render tool list
        setupPasswordFeatures('login-form');
        setupPasswordFeatures('signup-form');
        
    </script>
</body>
</html>




